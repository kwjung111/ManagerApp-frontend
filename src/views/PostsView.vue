
<script setup>
import axios from 'axios';
import Post from '../components/Post.vue'
import PostAddModal from '../components/PostAddModal.vue'
import Cmmn from '../common.js'
import MemoAddModal from '../components/MemoAddModal.vue'
import { ref, onMounted } from 'vue'

const url = Cmmn.url;
const wsUrl = Cmmn.wsUrl;

const curDt = ref(new Date())

//현재 시각 타이머
const timer = setInterval(() => {
    curDt.value = new Date()
}, 500)


const posts = ref(null)
const postsCount = ref(null)
const postSeqForMemo = ref(null)                  //메모를 삽입할 게시물번호
const postAddModalVisible = ref(false)
const memoAddModalVisible = ref(false)
const lastRefreshTime = ref(new Date())           //타이머 구현을 위해 마지막 refresh 시간을 받음
const postFilter = ref(0)                         //0 최근 1주일 접수, 1 처리중, 2 긴급
const statusActing = ref(false)
const statusEmergency = ref(false)

let connectState = true;


onMounted(() => {
    connectWs() //웹소켓 연결시 리프레시 수행
})

const refresh = async () => {
    axios.all([
        axios.get(`${url}/postTree`),          //게시물
        axios.get(`${url}/postsCount`),    //게시물수
        //TODO 리프레시 시간: 서버 시간 기준으로 바꾼다.
    ])
        .then((resArr) => {
            const postsData = resArr[0].data.result
            const postsCountData = resArr[1].data.result[0]

            posts.value = postsData
            postsCount.value = postsCountData

            //TODO timer 관련 동작은 별도 스레드로 빼기
            lastRefreshTime.value = new Date()
        })

}


//웹소켓 연결
function connectWs() {

    let ws;

    /*
    const reconnectTimer = setInterval(() => {
        console.log('reconnecting to server...')
        connectWs()
    }, 3000);
    */

    ws = new WebSocket(wsUrl)
    
    ws.onopen = async () => {
        console.log('연결되었습니다')
        connectState = true;
        refresh()
    }

    ws.onmessage = async (event) => {
        const data = JSON.parse(event.data)
        if (data.type == "message") {
            let msgData = data.data
            console.log("server message :", msgData.content);
        }
        else if (data.type == "event") {
            let evtData = data.data
            console.log("server event : ", evtData.event)

            //어떤 이벤트인지 보고 리프레시
            refresh();
        }
    };

    ws.onclose = async (e) => {
        if(connectState == true){
            console.log('서버와의 연결이 종료되었습니다.')
            connectState = false;
        }
        setTimeout(() => {
        console.log('reconnecting to server...')
        connectWs();
    },1000)}

}



function togglePostAddModal() {
    postAddModalVisible.value = !postAddModalVisible.value;
}

function toggleMemoAddModal(data=null){
    postSeqForMemo.value = data?.postSeq
    memoAddModalVisible.value = !memoAddModalVisible.value
}

//sidebar 클릭 이벤트
function clickActing() {
    statusActing.value = !statusActing.value
    if(statusActing.value){
        statusEmergency.value = false
        postFilter.value = 1
    }
    else{
        statusActing.value = false
        postFilter.value = 0
    }
}
function clickEmergency() {
    statusEmergency.value = !statusEmergency.value
    if(statusEmergency.value){
        statusActing.value = false
        postFilter.value = 2
    }
    else{
        statusEmergency.value = false
        postFilter.value = 0
    }
}
function clickList() {
    statusActing.value = false
    statusEmergency.value = false
    postFilter.value = 0
}

</script>

<template>
    <header>
        <div class="header-container">
            <div class="item">
                <h1> SR LIST </h1>
            </div>
            <div class="item">
                <p>{{ curDt }}</p>
            </div>
            <div class="item">
                <button class="post-add btn-common" @click="togglePostAddModal()" title="신규 SR 등록">
                    <span class="material-symbols-outlined">
                        add_box
                    </span>
                </button>
            </div>
        </div>
    </header>

    <section>
        <div class="container">
            <div class="sidebar">
                <div class="box"><button class="box-text" @click="clickList">최근 1주일 접수 <br><span class=strong>{{ postsCount?.recentPost }}</span></button> </div>
                <div class="box inProg"><button class="box-text" @click="clickActing" :class="{active: statusActing}">처리 중<br><span class=strong>{{ postsCount?.acting }}</span></button></div>
                <div class="box alert"><button class="box-text" @click="clickEmergency" :class="{active: statusEmergency}">긴급 처리 중<br><span class="strong">{{ postsCount?.emergency }}</span></button></div>
            </div>
            <div class="table-wrap">
                <div class="post-table">
                    <ul class="table-head">
                        <li class="col01">NO</li>
                        <li class="col02">등록일시</li>
                        <li class="col03">SR 내용</li>
                        <li class="col04">상태</li>
                        <li class="col05">경과/조치시간</li>
                        <li class="col06">작성자</li>
                        <li class="col07">비고</li>
                    </ul>
                    <div class="table-body" v-if="posts?.length">
                        <ol>
                            <Post v-if="posts" :posts="posts" :lastRefreshTime="lastRefreshTime" :postFilter="postFilter" @addMemo="toggleMemoAddModal"/>
                        </ol>
                    </div>
                    <div class="table-body" v-else>
                        <p class="no-db">아직 등록된 게시물이 없습니다 ! !</p>
                    </div>
                </div>
            </div>
            <!-- 리팩토링 필요 구간 start-->
            <template v-if="postAddModalVisible">
                <div @click="togglePostAddModal()" class="modal-bg">
                    <PostAddModal @closeModal="togglePostAddModal" />
                </div>
            </template>
            <template v-if="memoAddModalVisible">
                <div @click="toggleMemoAddModal()" class="modal-bg">
                    <MemoAddModal :postSeq="postSeqForMemo"  @closeModal="toggleMemoAddModal" />
                </div>
            </template>
            <!-- 구간 end -->
        </div>
    </section>
</template>
